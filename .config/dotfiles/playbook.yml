---
# Development environment setup and maintenance playbook
# This playbook ensures all development tools are installed and up-to-date
#
# Usage:
#   Initial setup:     uvx --from ansible-core ansible-playbook playbook.yml --tags setup
#   Update tools:      uvx --from ansible-core ansible-playbook playbook.yml
#   Check mode:        uvx --from ansible-core ansible-playbook playbook.yml --check
#   Dev tools:         uvx --from ansible-core ansible-playbook playbook.yml --extra-vars "dev_mode=true"
#   Force server mode: uvx --from ansible-core ansible-playbook playbook.yml --extra-vars "is_desktop=false"
#   Specific category: uvx --from ansible-core ansible-playbook playbook.yml --tags homebrew
#
# Variables:
#   dev_mode:   Install additional development tools (default: false)
#   is_desktop: Install desktop apps vs CLI-only tools (auto-detected, override with true/false)
#
# Desktop detection:
#   - macOS: Always treated as desktop
#   - Linux: Checks systemd default target (graphical.target = desktop)
#   - Override with --extra-vars "is_desktop=true" or "is_desktop=false"

- name: Manage development environment
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    dev_mode: false
    force: false
    # Desktop detection: macOS is always desktop, Linux checks systemd target
    # Override with --extra-vars "is_desktop=true" or "is_desktop=false"
    _linux_desktop: "{{ ansible_service_mgr == 'systemd' and (ansible_facts['default_target'] | default('multi-user.target')) == 'graphical.target' }}"
    is_desktop: "{{ is_desktop | default(true if ansible_os_family == 'Darwin' else _linux_desktop) }}"

  pre_tasks:
    - name: Gather systemd default target (Linux only)
      command: systemctl get-default
      register: systemd_target
      changed_when: false
      failed_when: false
      when: ansible_system == "Linux" and ansible_service_mgr == "systemd"

    - name: Set desktop fact from systemd target
      set_fact:
        is_desktop: "{{ is_desktop | default(true if ansible_os_family == 'Darwin' else (systemd_target.stdout | default('multi-user.target')) == 'graphical.target') }}"

    - name: Display system type
      debug:
        msg: "System type: {{ 'Desktop' if is_desktop else 'Server' }} ({{ ansible_os_family }})"

  tasks:
    # ========================================
    # HOMEBREW (macOS only)
    # ========================================
    - name: Install Homebrew
      tags: [setup, homebrew]
      when: ansible_os_family == "Darwin"
      block:
        - name: Check if Homebrew is installed
          stat:
            path: /opt/homebrew/bin/brew
          register: homebrew_check

        - name: Install Homebrew
          shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          when: not homebrew_check.stat.exists

    - name: Update Homebrew and packages
      tags: [homebrew]
      when: ansible_os_family == "Darwin"
      block:
        - name: Update Homebrew itself
          shell: brew update
          register: brew_update
          changed_when: "'Already up-to-date' not in brew_update.stdout"

        # Essential CLI tools - installed on all macOS systems
        - name: Install/upgrade essential Homebrew formulae
          shell: brew install {{ item }} || brew upgrade {{ item }} || true
          loop:
            - bat
            - eza
            - fd
            - fzf
            - jq
            - mise
            - ripgrep
            - starship
            - atuin
            - zsh-autosuggestions
            - zsh-syntax-highlighting
          register: brew_install
          changed_when: "'Upgrading' in brew_install.stdout or 'Installing' in brew_install.stdout"

        # Dev tools - only in dev mode
        - name: Install/upgrade dev Homebrew formulae
          shell: brew install {{ item }} || brew upgrade {{ item }} || true
          loop:
            - bat-extras
            - gh
            - yq
          register: brew_dev_install
          changed_when: "'Upgrading' in brew_dev_install.stdout or 'Installing' in brew_dev_install.stdout"
          when: dev_mode | bool

        # 1Password CLI - requires special tap
        - name: Tap 1Password CLI
          shell: brew tap 1password/tap
          changed_when: false
          failed_when: false

        - name: Install 1Password CLI
          shell: brew install 1password-cli || brew upgrade 1password-cli || true
          register: op_install
          changed_when: "'Upgrading' in op_install.stdout or 'Installing' in op_install.stdout"

        # Desktop-only casks
        - name: Install desktop Homebrew casks
          shell: brew install --cask {{ item }} || brew upgrade --cask {{ item }} || true
          loop:
            - visual-studio-code
            - 1password
          register: brew_cask_install
          changed_when: "'Upgrading' in brew_cask_install.stdout or 'Installing' in brew_cask_install.stdout"
          when: is_desktop | bool

        - name: Clean up Homebrew
          shell: brew cleanup
          register: brew_cleanup
          changed_when: false

    # ========================================
    # APT (Linux only)
    # ========================================
    - name: Update APT packages
      tags: [apt]
      when: ansible_pkg_mgr == "apt"
      block:
        - name: Update apt cache
          apt:
            update_cache: yes
            cache_valid_time: 3600
          become: yes

        - name: Upgrade all apt packages
          apt:
            upgrade: dist
          become: yes
          register: apt_upgrade

        # Essential CLI tools for all Linux systems
        - name: Install essential apt packages
          apt:
            name:
              - fd-find
              - fzf
              - jq
              - ripgrep
              - zsh-autosuggestions
              - zsh-syntax-highlighting
            state: latest
          become: yes

        # Dev tools - only in dev mode
        - name: Install dev apt packages
          apt:
            name:
              - gh
            state: latest
          become: yes
          when: dev_mode | bool

        # Desktop-only packages
        - name: Install desktop apt packages
          apt:
            name:
              - code
            state: latest
          become: yes
          when: is_desktop | bool
          failed_when: false

    # ========================================
    # 1PASSWORD CLI (Linux)
    # ========================================
    - name: Install 1Password CLI on Linux
      tags: [setup, tools]
      when: ansible_pkg_mgr == "apt"
      block:
        - name: Check if 1Password CLI is installed
          command: which op
          register: op_check
          changed_when: false
          failed_when: false

        - name: Add 1Password apt repository key
          shell: |
            curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
            gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
          args:
            creates: /usr/share/keyrings/1password-archive-keyring.gpg
          become: yes
          when: op_check.rc != 0

        - name: Add 1Password apt repository
          shell: |
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
            tee /etc/apt/sources.list.d/1password.list
          args:
            creates: /etc/apt/sources.list.d/1password.list
          become: yes
          when: op_check.rc != 0

        - name: Install 1Password CLI via apt
          apt:
            name: 1password-cli
            state: latest
            update_cache: yes
          become: yes

    # ========================================
    # MISE
    # ========================================
    # On macOS, mise is installed via Homebrew. On Linux, use the installer script.
    - name: Install mise (Linux only)
      tags: [mise, setup]
      when: ansible_os_family != "Darwin"
      block:
        - name: Check if mise is installed
          stat:
            path: "{{ ansible_env.HOME }}/.local/bin/mise"
          register: mise_check

        - name: Install mise
          shell: curl -fsSL https://mise.run | sh
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/mise"
          when: not mise_check.stat.exists

        - name: Update mise itself
          shell: "{{ ansible_env.HOME }}/.local/bin/mise self-update"
          register: mise_update
          changed_when: "'Updated' in mise_update.stdout or 'updated' in mise_update.stdout"
          failed_when: false

    - name: Install and upgrade mise tools from .mise.toml
      tags: [mise, runtimes]
      shell: |
        export PATH="{{ ansible_env.HOME }}/.local/bin:$PATH"
        mise install && mise upgrade
      args:
        chdir: "{{ ansible_env.HOME }}"
      register: mise_tools
      changed_when: "'installed' in mise_tools.stdout or 'Upgraded' in mise_tools.stdout"

    # ========================================
    # RUST
    # ========================================
    - name: Install Rust toolchain
      tags: [setup, rust]
      block:
        - name: Check if rustup is installed
          stat:
            path: "{{ ansible_env.HOME }}/.cargo/bin/rustup"
          register: rustup_check

        - name: Install Rust via rustup
          shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --profile minimal -y -q
          args:
            creates: "{{ ansible_env.HOME }}/.cargo/bin/rustup"
          when: not rustup_check.stat.exists

    - name: Update Rust toolchain
      tags: [rust]
      shell: "{{ ansible_env.HOME }}/.cargo/bin/rustup update"
      register: rustup_update
      changed_when: "'updated' in rustup_update.stdout or 'installing' in rustup_update.stdout"

    - name: Install cargo-update
      tags: [setup, rust]
      shell: "{{ ansible_env.HOME }}/.cargo/bin/cargo install cargo-update"
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo-install-update"

    - name: Update cargo packages
      tags: [rust]
      shell: "{{ ansible_env.HOME }}/.cargo/bin/cargo install-update -a"
      register: cargo_updates
      changed_when: "'Updating' in cargo_updates.stdout"
      failed_when: false

    # On Linux, install eza and bat via cargo (on macOS these come from Homebrew)
    - name: Install essential Rust tools (Linux only)
      tags: [setup, rust]
      when: ansible_os_family != "Darwin"
      shell: "{{ ansible_env.HOME }}/.cargo/bin/cargo install {{ item }}"
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/{{ item }}"
      loop:
        - eza
        - bat

    - name: Build bat cache
      tags: [setup, rust]
      shell: bat cache --build
      changed_when: false
      failed_when: false

    - name: Install Rust dev tools
      tags: [setup, rust, dev]
      when: dev_mode | bool
      shell: "{{ ansible_env.HOME }}/.cargo/bin/cargo install {{ item.name }} {{ item.flags | default('') }}"
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/{{ item.bin }}"
      loop:
        - { name: "evcxr_repl", bin: "evcxr", flags: "" }
        - { name: "evcxr_jupyter", bin: "evcxr_jupyter", flags: "--locked" }
        - { name: "onefetch", bin: "onefetch", flags: "" }

    - name: Setup Rust Jupyter kernel
      tags: [setup, rust, dev]
      when: dev_mode | bool
      shell: "{{ ansible_env.HOME }}/.cargo/bin/evcxr_jupyter --install"
      changed_when: false
      failed_when: false

    # ========================================
    # UV and Python packages
    # ========================================
    - name: Install uv
      tags: [setup, uv]
      block:
        - name: Check if uv is installed
          stat:
            path: "{{ ansible_env.HOME }}/.local/bin/uv"
          register: uv_check

        - name: Install uv
          shell: curl -LsSf https://astral.sh/uv/install.sh | sh
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/uv"
          when: not uv_check.stat.exists

    - name: Update uv tools
      tags: [uv]
      shell: |
        for tool in $({{ ansible_env.HOME }}/.local/bin/uv tool list 2>/dev/null | grep -v '^-' | awk '{ print $1}'); do
          echo "Updating $tool"
          {{ ansible_env.HOME }}/.local/bin/uv tool upgrade "$tool" || \
          {{ ansible_env.HOME }}/.local/bin/uv tool install "$tool" --reinstall
        done
      register: uv_updates
      changed_when: "'Installed' in uv_updates.stdout or 'Updated' in uv_updates.stdout"
      failed_when: false

    - name: Install Python tools via uv
      tags: [setup, uv, dev]
      when: dev_mode | bool
      shell: "{{ ansible_env.HOME }}/.local/bin/uv tool install {{ item }}"
      args:
        creates: "{{ ansible_env.HOME }}/.local/share/uv/tools/{{ item }}"
      loop:
        - yt-dlp
        - pygments
        - httpie
        - juv

    - name: Install Jupyter with scientific packages
      tags: [setup, uv, dev]
      when: dev_mode | bool
      shell: >
        {{ ansible_env.HOME }}/.local/bin/uv tool install jupyter-core
        --with jupyterlab
        --with requests
        --with pandas
        --with numpy
        --with matplotlib
        --with nbconvert
        --with nbclassic
      args:
        creates: "{{ ansible_env.HOME }}/.local/share/uv/tools/jupyter-core"

    - name: Install Deno Jupyter kernel
      tags: [setup, dev]
      when: dev_mode | bool
      shell: "{{ ansible_env.HOME }}/.local/share/mise/installs/deno/latest/bin/deno jupyter --install --force"
      changed_when: false
      failed_when: false

    # ========================================
    # OTHER TOOLS
    # ========================================
    - name: Install Claude Code
      tags: [setup, tools]
      block:
        - name: Check if Claude Code is installed
          stat:
            path: "{{ ansible_env.HOME }}/.local/bin/claude"
          register: claude_check

        - name: Install Claude Code
          shell: curl -fsSL https://claude.ai/install.sh | bash
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/claude"
          when: not claude_check.stat.exists

    # On macOS, starship is installed via Homebrew. On Linux, use the installer script.
    - name: Install Starship prompt (Linux only)
      tags: [setup, tools]
      when: ansible_os_family != "Darwin"
      block:
        - name: Check if Starship is installed
          stat:
            path: "{{ ansible_env.HOME }}/.local/bin/starship"
          register: starship_check

        - name: Install Starship
          shell: curl -sS https://starship.rs/install.sh | sh -s -- -y -b {{ ansible_env.HOME }}/.local/bin
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/starship"
          when: not starship_check.stat.exists

    # On macOS, atuin is installed via Homebrew. On Linux, use the installer script.
    - name: Install/update Atuin (Linux only)
      tags: [setup, tools]
      when: ansible_os_family != "Darwin"
      block:
        - name: Check if Atuin is installed
          command: which atuin
          register: atuin_check
          changed_when: false
          failed_when: false

        - name: Install Atuin
          shell: curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh
          when: atuin_check.rc != 0

        - name: Update Atuin
          shell: atuin-update
          when: atuin_check.rc == 0
          register: atuin_update
          changed_when: "'Updated' in atuin_update.stdout or 'updated' in atuin_update.stdout"
          failed_when: false

    # pnpm - installed via corepack (comes with Node.js via mise)
    - name: Enable pnpm via corepack
      tags: [setup, tools]
      block:
        - name: Check if corepack is available
          command: which corepack
          register: corepack_check
          changed_when: false
          failed_when: false

        - name: Enable pnpm via corepack
          shell: corepack enable pnpm
          when: corepack_check.rc == 0
          changed_when: false
          failed_when: false

    # VS Code CLI for server environments (desktop gets full VS Code via package manager)
    - name: Install VS Code CLI (server only)
      tags: [setup, tools]
      when: not is_desktop | bool
      block:
        - name: Check if code CLI is installed
          command: which code
          register: code_cli_check
          changed_when: false
          failed_when: false

        - name: Download and install VS Code CLI
          shell: |
            curl -Lk 'https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-x64' -o /tmp/vscode_cli.tar.gz
            tar -xf /tmp/vscode_cli.tar.gz -C {{ ansible_env.HOME }}/.local/bin
            rm /tmp/vscode_cli.tar.gz
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/code"
          when: code_cli_check.rc != 0

    - name: Setup tmux plugin manager
      tags: [setup, tools]
      block:
        - name: Check if tpm is installed
          stat:
            path: "{{ ansible_env.HOME }}/.tmux/plugins/tpm"
          register: tpm_check

        - name: Create tmux plugins directory
          file:
            path: "{{ ansible_env.HOME }}/.tmux/plugins"
            state: directory
            mode: '0755'
          when: not tpm_check.stat.exists

        - name: Clone tmux plugin manager
          git:
            repo: https://github.com/tmux-plugins/tpm
            dest: "{{ ansible_env.HOME }}/.tmux/plugins/tpm"
            update: yes

    # ========================================
    # SHELL COMPLETIONS
    # ========================================
    - name: Update shell completions
      tags: [completions]
      shell: "{{ ansible_env.HOME }}/.config/zsh/update-completions.sh"
      args:
        executable: /bin/zsh
      changed_when: false
      failed_when: false
