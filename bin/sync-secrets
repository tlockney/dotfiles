#!/usr/bin/env bash
# sync-secrets - Inject 1Password secrets into all .op_tpl template files.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/common.sh
source "$SCRIPT_DIR/lib/common.sh"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    echo "Usage: sync-secrets"
    echo ""
    echo "Inject 1Password secrets into all .op_tpl files tracked by yadm."
    exit 0
fi

require_command "yadm"
require_command "op" "brew install 1password-cli"

cd "$HOME" || exit 1

count=0
while IFS= read -r file; do
    out=${file%%.op_tpl}
    info "Injecting secrets into $out"
    op inject -i "$HOME/$file" -o "$HOME/$out"
    count=$((count + 1))
done < <(yadm ls-files | grep '.op_tpl')

success "Injected secrets into $count file(s)."
