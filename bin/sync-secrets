#!/usr/bin/env bash

set -euo pipefail

# Check if required commands are available
if ! command -v yadm >/dev/null 2>&1; then
    echo "Error: yadm is not installed" >&2
    exit 1
fi

if ! command -v op >/dev/null 2>&1; then
    echo "Error: 1Password CLI (op) is not installed" >&2
    exit 1
fi

# Run 1password secret injection on all .op_tpl files
cd "$HOME" || exit 1
while IFS= read -r file; do
    out=${file%%.op_tpl}
    echo "Injecting secrets into $out"
    op inject -i "$HOME/$file" -o "$HOME/$out"
done < <(yadm ls-files | grep '.op_tpl')
