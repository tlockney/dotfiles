---
# Development environment setup and maintenance playbook
# This playbook ensures all development tools are installed and up-to-date
#
# Usage:
#   Initial setup:     uvx --from ansible-core ansible-playbook playbook.yml --tags setup
#   Update tools:      uvx --from ansible-core ansible-playbook playbook.yml
#   Check mode:        uvx --from ansible-core ansible-playbook playbook.yml --check
#   Dev tools:         uvx --from ansible-core ansible-playbook playbook.yml --extra-vars "dev_mode=true"
#   Force server mode: uvx --from ansible-core ansible-playbook playbook.yml --extra-vars "is_desktop=false"
#   Specific category: uvx --from ansible-core ansible-playbook playbook.yml --tags homebrew
#
# Variables:
#   dev_mode:   Install additional development tools (default: false)
#   is_desktop: Install desktop apps vs CLI-only tools (auto-detected, override with true/false)
#
# Desktop detection:
#   - macOS: Always treated as desktop
#   - Linux: Checks systemd default target (graphical.target = desktop)
#   - Override with --extra-vars "is_desktop=true" or "is_desktop=false"

- name: Manage development environment
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    dev_mode: false
    force: false
    # Standard paths for tools (to avoid PATH dependency during bootstrap)
    local_bin: "{{ ansible_env.HOME }}/.local/bin"
    cargo_bin: "{{ ansible_env.HOME }}/.cargo/bin"

  pre_tasks:
    # Desktop detection: macOS is always desktop, Linux checks systemd target
    # Override with --extra-vars "is_desktop=true" or "is_desktop=false"
    # Use 'always' tag so these run even when filtering by tags
    - name: Gather systemd default target (Linux only)
      tags: [always]
      command: systemctl get-default
      register: systemd_target
      changed_when: false
      failed_when: false
      when: ansible_system == "Linux" and ansible_service_mgr == "systemd"

    - name: Set desktop fact (macOS is always desktop)
      tags: [always]
      set_fact:
        is_desktop: true
      when: is_desktop is not defined and ansible_os_family == "Darwin"

    - name: Set desktop fact (Linux checks systemd target)
      tags: [always]
      set_fact:
        is_desktop: "{{ (systemd_target.stdout | default('multi-user.target')) == 'graphical.target' }}"
      when: is_desktop is not defined and ansible_os_family != "Darwin"

    - name: Display system type
      tags: [always]
      debug:
        msg: "System type: {{ 'Desktop' if is_desktop else 'Server' }} ({{ ansible_os_family }})"

    # Homebrew support detection: macOS always, Linux only on x86_64/aarch64
    - name: Set Homebrew support fact
      tags: [always]
      set_fact:
        homebrew_supported: "{{ ansible_os_family == 'Darwin' or ansible_architecture in ['x86_64', 'aarch64'] }}"

    - name: Set Homebrew path (macOS)
      tags: [always]
      set_fact:
        brew_bin: /opt/homebrew/bin/brew
      when: ansible_os_family == "Darwin"

    - name: Set Homebrew path (Linux)
      tags: [always]
      set_fact:
        brew_bin: /home/linuxbrew/.linuxbrew/bin/brew
      when: ansible_os_family != "Darwin" and homebrew_supported

    - name: Display Homebrew status
      tags: [always]
      debug:
        msg: "Homebrew: {{ 'supported' if homebrew_supported else 'not supported (32-bit ARM)' }}"

  tasks:
    # ========================================
    # HOMEBREW
    # ========================================
    - name: Install Homebrew (macOS)
      tags: [setup, homebrew]
      when: ansible_os_family == "Darwin"
      block:
        - name: Check if Homebrew is installed
          stat:
            path: /opt/homebrew/bin/brew
          register: homebrew_check

        - name: Install Homebrew
          shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          when: not homebrew_check.stat.exists

    - name: Install Homebrew (Linux)
      tags: [setup, homebrew]
      when: ansible_os_family != "Darwin" and homebrew_supported
      block:
        - name: Check if Homebrew is installed
          stat:
            path: /home/linuxbrew/.linuxbrew/bin/brew
          register: homebrew_linux_check

        - name: Check if Homebrew directory exists
          stat:
            path: /home/linuxbrew/.linuxbrew
          register: homebrew_dir_check
          when: not homebrew_linux_check.stat.exists

        - name: Fail if Homebrew directory needs creation
          fail:
            msg: |
              Homebrew directory /home/linuxbrew/.linuxbrew does not exist.
              Please create it manually with:
                sudo mkdir -p /home/linuxbrew/.linuxbrew
                sudo chown $(id -un):$(id -gn) /home/linuxbrew/.linuxbrew
              Then run provision again.
          when: not homebrew_linux_check.stat.exists and not homebrew_dir_check.stat.exists

        - name: Install Homebrew
          shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          environment:
            NONINTERACTIVE: "1"
          when: not homebrew_linux_check.stat.exists

    - name: Update Homebrew and packages
      tags: [homebrew]
      when: homebrew_supported
      block:
        - name: Update Homebrew itself
          shell: "{{ brew_bin }} update"
          register: brew_update
          changed_when: "'Already up-to-date' not in brew_update.stdout"

        # Essential CLI tools - installed on all Homebrew systems
        - name: Install/upgrade essential Homebrew formulae
          shell: "{{ brew_bin }} install {{ item }} || {{ brew_bin }} upgrade {{ item }} || true"
          loop:
            - atuin
            - bat
            - eza
            - fd
            - fzf
            - glow
            - jless
            - jq
            - mise
            - pandoc
            - ripgrep
            - sqlite
            - starship
          register: brew_install
          changed_when: "'Upgrading' in brew_install.stdout or 'Installing' in brew_install.stdout"

        # zsh plugins (may not be available on Linux Homebrew, fail gracefully)
        - name: Install/upgrade zsh plugins
          shell: "{{ brew_bin }} install {{ item }} || {{ brew_bin }} upgrade {{ item }} || true"
          loop:
            - zsh-autosuggestions
            - zsh-syntax-highlighting
          register: brew_zsh_install
          changed_when: "'Upgrading' in brew_zsh_install.stdout or 'Installing' in brew_zsh_install.stdout"
          failed_when: false

        # Dev tools - only in dev mode
        - name: Install/upgrade dev Homebrew formulae
          shell: "{{ brew_bin }} install {{ item }} || {{ brew_bin }} upgrade {{ item }} || true"
          loop:
            - bat-extras
            - gh
            - yq
          register: brew_dev_install
          changed_when: "'Upgrading' in brew_dev_install.stdout or 'Installing' in brew_dev_install.stdout"
          when: dev_mode | bool

        # 1Password CLI
        - name: Install 1Password CLI
          shell: "{{ brew_bin }} install 1password-cli || {{ brew_bin }} upgrade 1password-cli || true"
          register: op_install
          changed_when: "'Upgrading' in op_install.stdout or 'Installing' in op_install.stdout"

        - name: Clean up Homebrew
          shell: "{{ brew_bin }} cleanup"
          register: brew_cleanup
          changed_when: false

    # macOS-only casks
    - name: Install macOS desktop casks
      tags: [homebrew]
      when: ansible_os_family == "Darwin" and is_desktop | bool
      block:
        - name: Install desktop Homebrew casks
          shell: "{{ brew_bin }} install --cask {{ item }} || {{ brew_bin }} upgrade --cask {{ item }} || true"
          loop:
            - visual-studio-code
            - 1password
          register: brew_cask_install
          changed_when: "'Upgrading' in brew_cask_install.stdout or 'Installing' in brew_cask_install.stdout"

        # Display mode switching tools (for multi-Mac desk setup)
        - name: Install display switching casks
          shell: "{{ brew_bin }} install --cask {{ item }} || {{ brew_bin }} upgrade --cask {{ item }} || true"
          loop:
            - betterdisplay
          register: brew_display_cask_install
          changed_when: "'Upgrading' in brew_display_cask_install.stdout or 'Installing' in brew_display_cask_install.stdout"

        - name: Install display-switch formula
          shell: "{{ brew_bin }} install display-switch || {{ brew_bin }} upgrade display-switch || true"
          register: brew_display_switch_install
          changed_when: "'Upgrading' in brew_display_switch_install.stdout or 'Installing' in brew_display_switch_install.stdout"

    # ========================================
    # APT (Linux only)
    # ========================================
    - name: Update APT packages
      tags: [apt]
      when: ansible_pkg_mgr == "apt"
      block:
        - name: Update apt cache
          apt:
            update_cache: yes
            cache_valid_time: 3600
          become: yes

        - name: Upgrade all apt packages
          apt:
            upgrade: dist
          become: yes
          register: apt_upgrade

        # Essential CLI tools for all Linux systems
        - name: Install essential apt packages
          apt:
            name:
              - fd-find
              - fzf
              - jq
              - ripgrep
              - zsh-autosuggestions
              - zsh-syntax-highlighting
            state: latest
          become: yes

        # Dev tools - only in dev mode
        - name: Install dev apt packages
          apt:
            name:
              - gh
            state: latest
          become: yes
          when: dev_mode | bool

        # Desktop-only packages
        - name: Install desktop apt packages
          apt:
            name:
              - code
            state: latest
          become: yes
          when: is_desktop | bool
          failed_when: false

    # ========================================
    # 1PASSWORD CLI (Linux without Homebrew)
    # ========================================
    - name: Install 1Password CLI on Linux (non-Homebrew)
      tags: [setup, tools]
      when: ansible_pkg_mgr == "apt" and not homebrew_supported
      block:
        - name: Check if 1Password CLI is installed
          command: which op
          register: op_check
          changed_when: false
          failed_when: false

        - name: Add 1Password apt repository key
          shell: |
            curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
            gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
          args:
            creates: /usr/share/keyrings/1password-archive-keyring.gpg
          become: yes
          when: op_check.rc != 0

        - name: Add 1Password apt repository
          shell: |
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
            tee /etc/apt/sources.list.d/1password.list
          args:
            creates: /etc/apt/sources.list.d/1password.list
          become: yes
          when: op_check.rc != 0

        - name: Install 1Password CLI via apt
          apt:
            name: 1password-cli
            state: latest
            update_cache: yes
          become: yes

    # ========================================
    # MISE
    # ========================================
    # Mise is installed via Homebrew on supported systems
    # Install mise tools using Homebrew path or shims
    - name: Install and upgrade mise tools from .mise.toml
      tags: [mise, runtimes]
      when: homebrew_supported
      shell: "{{ brew_bin | regex_replace('/brew$', '/mise') }} install && {{ brew_bin | regex_replace('/brew$', '/mise') }} upgrade"
      args:
        chdir: "{{ ansible_env.HOME }}"
      register: mise_tools
      changed_when: "'installed' in mise_tools.stdout or 'Upgraded' in mise_tools.stdout"
      failed_when: false

    # ========================================
    # RUST
    # ========================================
    - name: Install Rust toolchain
      tags: [setup, rust]
      block:
        - name: Check if rustup is installed
          stat:
            path: "{{ ansible_env.HOME }}/.cargo/bin/rustup"
          register: rustup_check

        - name: Install Rust via rustup
          shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --profile minimal -y -q
          args:
            creates: "{{ ansible_env.HOME }}/.cargo/bin/rustup"
          when: not rustup_check.stat.exists

    - name: Update Rust toolchain
      tags: [rust]
      shell: "{{ ansible_env.HOME }}/.cargo/bin/rustup update"
      register: rustup_update
      changed_when: "'updated' in rustup_update.stdout or 'installing' in rustup_update.stdout"

    - name: Install cargo-update
      tags: [setup, rust]
      shell: "{{ ansible_env.HOME }}/.cargo/bin/cargo install cargo-update"
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo-install-update"

    - name: Update cargo packages
      tags: [rust]
      shell: "{{ ansible_env.HOME }}/.cargo/bin/cargo install-update -a"
      register: cargo_updates
      changed_when: "'Updating' in cargo_updates.stdout"
      failed_when: false

    # Build bat cache (bat is installed via Homebrew)
    - name: Build bat cache
      tags: [setup, rust]
      when: homebrew_supported
      shell: "{{ brew_bin | regex_replace('/brew$', '/bat') }} cache --build"
      changed_when: false
      failed_when: false

    # ========================================
    # UV and Python packages
    # ========================================
    - name: Install uv
      tags: [setup, uv]
      block:
        - name: Check if uv is installed
          stat:
            path: "{{ ansible_env.HOME }}/.local/bin/uv"
          register: uv_check

        - name: Install uv
          shell: curl -LsSf https://astral.sh/uv/install.sh | sh
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/uv"
          when: not uv_check.stat.exists

    - name: Update uv tools
      tags: [uv]
      shell: |
        for tool in $({{ ansible_env.HOME }}/.local/bin/uv tool list 2>/dev/null | grep -v '^-' | awk '{ print $1}'); do
          echo "Updating $tool"
          {{ ansible_env.HOME }}/.local/bin/uv tool upgrade "$tool" || \
          {{ ansible_env.HOME }}/.local/bin/uv tool install "$tool" --reinstall
        done
      register: uv_updates
      changed_when: "'Installed' in uv_updates.stdout or 'Updated' in uv_updates.stdout"
      failed_when: false

    - name: Install Python tools via uv
      tags: [setup, uv, dev]
      when: dev_mode | bool
      shell: "{{ ansible_env.HOME }}/.local/bin/uv tool install {{ item }}"
      args:
        creates: "{{ ansible_env.HOME }}/.local/share/uv/tools/{{ item }}"
      loop:
        - yt-dlp
        - pygments
        - httpie
        - juv

    - name: Install Jupyter with scientific packages
      tags: [setup, uv, dev]
      when: dev_mode | bool
      shell: >
        {{ ansible_env.HOME }}/.local/bin/uv tool install jupyter-core
        --with jupyterlab
        --with requests
        --with pandas
        --with numpy
        --with matplotlib
        --with nbconvert
        --with nbclassic
      args:
        creates: "{{ ansible_env.HOME }}/.local/share/uv/tools/jupyter-core"

    - name: Install Deno Jupyter kernel
      tags: [setup, dev]
      when: dev_mode | bool
      shell: "{{ ansible_env.HOME }}/.local/share/mise/shims/deno jupyter --install --force"
      changed_when: false
      failed_when: false

    # ========================================
    # OTHER TOOLS
    # ========================================
    - name: Install Claude Code
      tags: [setup, tools]
      block:
        - name: Check if Claude Code is installed
          stat:
            path: "{{ ansible_env.HOME }}/.local/bin/claude"
          register: claude_check

        - name: Install Claude Code
          shell: curl -fsSL https://claude.ai/install.sh | bash
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/claude"
          when: not claude_check.stat.exists

    # pnpm - installed via corepack (comes with Node.js via mise)
    # Use mise shims path to find corepack regardless of shell PATH
    - name: Enable pnpm via corepack
      tags: [setup, tools]
      block:
        - name: Check if corepack is available via mise shims
          stat:
            path: "{{ ansible_env.HOME }}/.local/share/mise/shims/corepack"
          register: corepack_shim_check

        - name: Enable pnpm via corepack
          shell: "{{ ansible_env.HOME }}/.local/share/mise/shims/corepack enable pnpm"
          when: corepack_shim_check.stat.exists
          changed_when: false
          failed_when: false

    # VS Code CLI for server environments (desktop gets full VS Code via package manager)
    - name: Install VS Code CLI (server only)
      tags: [setup, tools]
      when: not is_desktop | bool
      block:
        - name: Check if code CLI is installed
          command: which code
          register: code_cli_check
          changed_when: false
          failed_when: false

        - name: Download and install VS Code CLI
          shell: |
            curl -Lk 'https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-x64' -o /tmp/vscode_cli.tar.gz
            tar -xf /tmp/vscode_cli.tar.gz -C {{ ansible_env.HOME }}/.local/bin
            rm /tmp/vscode_cli.tar.gz
          args:
            creates: "{{ ansible_env.HOME }}/.local/bin/code"
          when: code_cli_check.rc != 0

    - name: Setup tmux plugin manager
      tags: [setup, tools]
      block:
        - name: Check if tpm is installed
          stat:
            path: "{{ ansible_env.HOME }}/.tmux/plugins/tpm"
          register: tpm_check

        - name: Create tmux plugins directory
          file:
            path: "{{ ansible_env.HOME }}/.tmux/plugins"
            state: directory
            mode: '0755'
          when: not tpm_check.stat.exists

        - name: Clone tmux plugin manager
          git:
            repo: https://github.com/tmux-plugins/tpm
            dest: "{{ ansible_env.HOME }}/.tmux/plugins/tpm"
            update: yes

    # ========================================
    # SHELL COMPLETIONS
    # ========================================
    - name: Update shell completions
      tags: [completions]
      shell: "{{ ansible_env.HOME }}/.config/zsh/update-completions.sh"
      args:
        executable: /bin/zsh
      changed_when: false
      failed_when: false
