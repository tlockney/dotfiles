#!/usr/bin/env bash
# check-env - Run environment sanity checks.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/common.sh
source "$SCRIPT_DIR/lib/common.sh"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    echo "Usage: check-env"
    echo ""
    echo "Run environment sanity checks: lint .zshrc and verify essential CLI tools."
    exit 0
fi

info "Running environment sanity checks..."

# Lint .zshrc for syntax errors
if [ -f "$HOME/.zshrc" ]; then
  info "Linting .zshrc..."
  if zsh -n "$HOME/.zshrc"; then
    success ".zshrc syntax is OK."
  else
    error ".zshrc syntax error!"
  fi
else
  warn "Skipping .zshrc lint, file not found."
fi

echo ""
info "Checking for essential commands..."
commands_to_check="eza bat fd rg atuin mise"
missing=0
for cmd in $commands_to_check; do
  if has_command "$cmd"; then
    echo -e "  ${GREEN}✓${NC} $cmd"
  else
    echo -e "  ${RED}✗${NC} $cmd ${RED}NOT FOUND${NC}"
    missing=$((missing + 1))
  fi
done

echo ""
if [[ $missing -gt 0 ]]; then
    warn "$missing command(s) not found."
    exit 1
else
    success "All essential commands found."
fi
